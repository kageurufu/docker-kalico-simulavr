[gcode_macro SET_PAUSE_NEXT_LAYER]
description: Enable a pause if the next layer is reached
gcode:
  {% set MACRO = params.MACRO | default("PAUSE", true) %}
  SET_GCODE_VARIABLE MACRO=SET_PRINT_STATS_INFO VARIABLE=pause_next_layer VALUE="{{'enable': True, 'call': MACRO}}"

[gcode_macro SET_PAUSE_AT_LAYER]
description: Enable/disable a pause if a given layer number is reached
gcode:
  {% set MACRO = params.MACRO | default("PAUSE", true) %}
  {% set LAYER = params.LAYER | default(0, true) | int %}
  {% if params.LAYER is defined %}
    SET_GCODE_VARIABLE MACRO=SET_PRINT_STATS_INFO VARIABLE=pause_at_layer VALUE="{{'enable': True, 'layer': LAYER, 'call': MACRO}}"
  {% else %}
    SET_GCODE_VARIABLE MACRO=SET_PRINT_STATS_INFO VARIABLE=pause_at_layer VALUE="{{'enable': False, 'layer': 0, 'call': "PAUSE"}}"
  {% endif %}

[gcode_macro SET_PRINT_STATS_INFO]
rename_existing: SET_PRINT_STATS_INFO_BASE
description: Pass slicer info like layer act and total to klipper (pause_next_layer and pause_at_layer enabled)
variable_pause_next_layer: {'enable': False, 'call': "PAUSE"}
variable_pause_at_layer  : {'enable': False, 'layer': 0, 'call': "PAUSE"}
gcode:
  {% if pause_next_layer.enable %}
    M117 {pause_next_layer.call}, forced by pause_next_layer
    {pause_next_layer.call}
    SET_GCODE_VARIABLE MACRO=SET_PRINT_STATS_INFO VARIABLE=pause_next_layer VALUE="{{'enable': False, 'call': "PAUSE"}}"
  {% elif pause_at_layer.enable and params.CURRENT_LAYER is defined and params.CURRENT_LAYER|int == pause_at_layer.layer %}
    M117 {pause_at_layer.call}, forced by pause_at_layer [{pause_at_layer.layer}]
    {pause_at_layer.call}
    SET_GCODE_VARIABLE MACRO=SET_PRINT_STATS_INFO VARIABLE=pause_at_layer VALUE="{{'enable': False, 'layer': 0, 'call': "PAUSE"}}"
  {% endif %}
  SET_PRINT_STATS_INFO_BASE {rawparams}
